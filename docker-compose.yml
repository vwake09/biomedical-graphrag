# Biomedical GraphRAG - Docker Compose Configuration
# Includes: App, Neo4j, Qdrant

services:
  # ============================================
  # Biomedical GraphRAG Application
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: biomedical-graphrag-app
    ports:
      - "8000:8000"
    environment:
      # OpenAI Configuration
      - OPENAI__API_KEY=${OPENAI__API_KEY}
      - OPENAI__MODEL=${OPENAI__MODEL:-gpt-4o-mini}
      - OPENAI__TEMPERATURE=${OPENAI__TEMPERATURE:-0.0}
      - OPENAI__MAX_TOKENS=${OPENAI__MAX_TOKENS:-1500}
      # Neo4j Configuration (use container hostname)
      - NEO4J__URI=bolt://neo4j:7687
      - NEO4J__USERNAME=${NEO4J__USERNAME:-neo4j}
      - NEO4J__PASSWORD=${NEO4J__PASSWORD}
      - NEO4J__DATABASE=${NEO4J__DATABASE:-neo4j}
      # Qdrant Configuration (use container hostname)
      - QDRANT__URL=http://qdrant:6333
      - QDRANT__API_KEY=${QDRANT__API_KEY:-}
      - QDRANT__COLLECTION_NAME=${QDRANT__COLLECTION_NAME:-biomedical_papers}
      - QDRANT__EMBEDDING_MODEL=${QDRANT__EMBEDDING_MODEL:-text-embedding-3-small}
      - QDRANT__EMBEDDING_DIMENSION=${QDRANT__EMBEDDING_DIMENSION:-1536}
      # Data Paths (relative to container)
      - JSON_DATA__PUBMED_JSON_PATH=data/pubmed_dataset.json
      - JSON_DATA__GENE_JSON_PATH=data/gene_dataset.json
    depends_on:
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - graphrag-network
    restart: unless-stopped

  # ============================================
  # Neo4j Graph Database
  # ============================================
  neo4j:
    image: neo4j:5-community
    container_name: biomedical-graphrag-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J__USERNAME:-neo4j}/${NEO4J__PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - graphrag-network
    restart: unless-stopped

  # ============================================
  # Qdrant Vector Database
  # ============================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: biomedical-graphrag-qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - graphrag-network
    restart: unless-stopped

# ============================================
# Networks
# ============================================
networks:
  graphrag-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  qdrant_data:
    driver: local

